# Dify 工作流配置指南

## 问题诊断

根据测试结果，您的 Dify 工作流存在配置问题，导致 500 内部服务器错误。

## 🔍 当前状态

✅ **API 连接正常**：可以成功连接到 Dify API  
✅ **文件上传成功**：图片可以成功上传到 Dify  
✅ **应用类型正确**：确认是工作流应用 (`"mode":"workflow"`)  
❌ **工作流执行失败**：所有输入格式都返回 500 错误  

## 🛠️ 需要检查的配置

### 1. 工作流输入参数

在 Dify 工作流中，请确认：

- **输入节点名称**：应该是 `upload`、`image` 或 `file_id` 之一
- **输入类型**：设置为 `File` 或 `Image` 类型
- **是否必填**：如果设置为必填，确保有默认值或正确传递

### 2. 工作流节点连接

检查工作流中的所有节点：

- **开始节点**：确保正确连接到第一个处理节点
- **中间节点**：确保所有节点都正确连接
- **结束节点**：确保有明确的输出节点

### 3. 常见配置错误

#### 输入参数不匹配
```
错误：工作流期望 "document" 但我们发送 "upload"
解决：修改工作流输入参数名为 "upload" 或修改代码中的参数名
```

#### 缺少必要的节点
```
错误：工作流缺少图片处理节点
解决：添加 "图片理解" 或 "视觉分析" 节点
```

#### 输出格式错误
```
错误：工作流没有正确的输出格式
解决：确保最后一个节点输出 JSON 格式的结果
```

## 🔧 推荐的工作流结构

```
[开始] → [输入:upload(File)] → [图片理解] → [文本处理] → [输出:result] → [结束]
```

### 详细步骤：

1. **开始节点**
   - 自动生成，无需配置

2. **输入节点**
   - 名称：`upload`
   - 类型：`File`
   - 描述：上传的发票图片

3. **图片理解节点**
   - 使用 GPT-4V 或其他视觉模型
   - 输入：连接到 `upload` 参数
   - 提示词：分析中国电子发票内容

4. **输出节点**
   - 名称：`result`
   - 类型：`Object`
   - 内容：结构化的发票信息

## 🧪 测试步骤

1. **在 Dify 控制台手动测试**
   - 上传一张发票图片
   - 运行工作流
   - 检查是否有错误

2. **检查日志**
   - 查看 Dify 工作流执行日志
   - 找出具体的错误节点

3. **简化测试**
   - 创建一个最简单的工作流（只有输入和输出）
   - 逐步添加节点直到找到问题

## 📞 获取帮助

如果问题持续存在：

1. **检查 Dify 文档**：https://docs.dify.ai/
2. **联系 Dify 支持**：提供工作流 ID 和错误信息
3. **社区论坛**：在 Dify 社区寻求帮助

## 🔄 修复后测试

修复工作流配置后，运行以下命令测试：

```bash
cd /home/scorpiouser/django/prj_file_proceed
./test_single_image.py
```

如果看到 "✅ Workflow successful!" 说明问题已解决。